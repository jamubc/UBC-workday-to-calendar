<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBC Workday to Calendar</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        :root {
            --ubc-blue: #002145;
            --ubc-blue-deep: #00132d;
            --ubc-gold: #fdb515;
            --ubc-white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1 {
            margin-bottom: 12px;
        }

        .title-goal {
            font-size: 14px;
            font-weight: 400;
            color: #666;
            display: block;
            margin-top: 6px;
        }

        .step-heading {
            margin: 0 0 8px;
            font-size: 13px;
            color: #666;
        }

        .step-block {
            margin: 18px 0 22px;
        }

        .file-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: nowrap;
            margin: 8px 0 10px;
        }

        .privacy-note {
            margin: 0;
            font-size: 12px;
            color: #2e7d32;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1 1 auto;
        }

        .privacy-icon {
            width: 14px;
            height: 14px;
            fill: currentColor;
            flex: 0 0 auto;
        }

        .file-row input[type="file"] {
            flex: 0 0 auto;
        }

        h2 {
            margin: 30px 0 15px 0;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid #ccc;
            padding-bottom: 8px;
        }

        .info {
            color: #666;
            margin-bottom: 20px;
        }

        .howto-banner {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px 14px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 0;
            margin-bottom: 12px;
            font-size: 13px;
            color: #444;
            text-align: center;
        }

        .howto-step {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 999px;
            background: #e8e8e8;
            color: #333;
            border: 1px solid #ccc;
            font-size: 12px;
            font-weight: 700;
        }

        .step-sep {
            color: #999;
            font-weight: 700;
        }

        .howto-link {
            color: inherit;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .howto-link:hover {
            color: #222;
        }

        .wd-icon-gear {
            width: 16px;
            height: 16px;
            vertical-align: -2px;
        }

        .wd-icon-gear .wd-icon-background {
            fill: currentColor;
            opacity: 0.25;
        }

        .wd-icon-gear .wd-icon-fill {
            fill: currentColor;
        }

        input[type="file"] {
            margin: 0;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #status {
            margin: 20px 0;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 11px;
            max-height: 120px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 10px 12px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #e8e8e8;
            font-weight: 600;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        tr:hover {
            background: #f0f0f0;
        }

        td:first-child {
            font-weight: 500;
            max-width: 200px;
        }

        td:nth-child(3),
        td:nth-child(4),
        td:nth-child(5) {
            white-space: nowrap;
        }

        .error {
            color: #c00;
        }

        .success {
            color: #060;
        }

        #calendar {
            margin-top: 15px;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
        }

        #calendarSection {
            display: none;
        }

        /* Minimal FullCalendar overrides */
        .fc {
            font-size: 12px;
        }

        .fc-toolbar-title {
            font-size: 16px !important;
        }

        .fc-button {
            padding: 4px 10px !important;
            font-size: 12px !important;
        }

        .fc-event {
            font-size: 11px;
            padding: 2px 4px;
        }

        .site-footer {
            margin-top: auto;
            background: var(--ubc-blue);
            color: var(--ubc-white);
            padding: 12px 0;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
        }

        .site-footer h2 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 700;
            border: none;
            padding-bottom: 0;
        }

        .site-footer a {
            color: var(--ubc-gold);
            text-decoration: none;
        }

        .site-footer a:hover {
            text-decoration: underline;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .page-content {
            width: 100%;
            max-width: 1000px;
            margin: 40px auto 0;
            padding: 0 20px 32px;
        }

        .footer-text {
            max-width: 720px;
        }

        .footer-note {
            margin-bottom: 6px;
            color: rgba(255, 255, 255, 0.88);
            font-size: 13px;
        }

        .footer-callout {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.78);
            letter-spacing: 0.1px;
        }

        .footer-actions {
            display: inline-flex;
            align-items: center;
            gap: 14px;
        }

        .footer-arrow {
            width: 44px;
            height: 16px;
            stroke: rgba(255, 255, 255, 0.75);
            stroke-width: 2;
            fill: none;
        }

        .footer-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .footer-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #0d1117;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-decoration: none;
            white-space: nowrap;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
            gap: 8px;
            font-size: 13px;
        }

        .footer-cta:hover {
            text-decoration: none;
            background: #161b22;
        }

        .footer-cta svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        @media (max-width: 700px) {
            .footer-content {
                align-items: flex-start;
            }

            .footer-actions {
                width: 100%;
                justify-content: flex-start;
                gap: 10px;
                flex-wrap: wrap;
            }

            .footer-cta {
                width: 100%;
            }

            .file-row {
                flex-direction: column;
                align-items: center;
                flex-wrap: wrap;
            }
        }

        @media (min-width: 900px) {
            .howto-banner {
                flex-wrap: nowrap;
                gap: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <main class="page-content">
        <h1>UBC Workday to Calendar <span class="title-goal">(goal: Upload your Workday Excel export (.xlsx) to convert it to an .ics calendar file.)</span></h1>
        <div class="step-block">
            <p class="step-heading">Step 1: Get your .xlsx file from Workday</p>
            <div class="howto-banner" aria-label="Workday export steps">
                <div class="howto-step"><span class="step-num">1</span><span>Go to <a class="howto-link" href="https://myworkday.ubc.ca/" target="_blank" rel="noopener">Workday</a></span></div>
                <span class="step-sep">→</span>
                <div class="howto-step"><span class="step-num">2</span><span>Click "Academics"</span></div>
                <span class="step-sep">→</span>
                <div class="howto-step"><span class="step-num">3</span><span>Click "Registration &amp; Courses"</span></div>
                <span class="step-sep">→</span>
                <div class="howto-step"><span class="step-num">4</span><span>Click the <svg width="24" height="24" class="wd-icon-gear wd-icon" role="presentation" viewBox="0 0 24 24"><g fill-rule="evenodd" class="wd-icon-container"><path d="m12.838 2.75.497 2.483a1.632 1.632 0 0 0 2.506 1.038l2.107-1.404 1.185 1.185-1.404 2.107a1.632 1.632 0 0 0 1.038 2.506l2.483.497v1.676l-2.483.497a1.632 1.632 0 0 0-1.038 2.506l1.404 2.107-1.185 1.185-2.107-1.404a1.632 1.632 0 0 0-2.506 1.038l-.497 2.483h-1.676l-.497-2.483a1.632 1.632 0 0 0-2.506-1.038l-2.107 1.404-1.185-1.185 1.404-2.107a1.632 1.632 0 0 0-1.038-2.506l-2.483-.497v-1.676l2.483-.497A1.632 1.632 0 0 0 6.271 8.16L4.867 6.052l1.185-1.185L8.159 6.27a1.632 1.632 0 0 0 2.506-1.038l.497-2.483zM12 9.28a2.72 2.72 0 1 0 0 5.44 2.72 2.72 0 0 0 0-5.44Z" class="wd-icon-background"></path><path fill-rule="nonzero" d="M12.99 2c.558 0 1.096.43 1.205.977l.503 2.51 2.13-1.42c.458-.305 1.142-.239 1.543.161l1.4 1.401c.395.395.471 1.079.162 1.543l-1.42 2.13 2.51.503c.54.108.977.638.977 1.204v1.982c0 .557-.43 1.095-.977 1.204l-2.51.503 1.42 2.13c.305.458.239 1.142-.161 1.543l-1.401 1.4c-.395.395-1.079.471-1.543.162l-2.13-1.42-.503 2.51c-.108.54-.638.977-1.204.977h-1.982c-.557 0-1.095-.43-1.204-.977l-.503-2.51-2.13 1.42c-.458.305-1.142.239-1.543-.161l-1.4-1.401c-.395-.395-.471-1.079-.162-1.543l1.42-2.13-2.51-.503c-.54-.108-.977-.638-.977-1.204v-1.982c0-.557.43-1.095.977-1.204l2.51-.503-1.42-2.13c-.305-.458-.239-1.142.161-1.543l1.401-1.4c.395-.395 1.079-.471 1.543-.162l2.13 1.42.503-2.51c.108-.54.638-.977 1.204-.977zm-.22 1.5h-1.54l-.457 2.282a1.5 1.5 0 0 1-2.303.954L6.534 5.445l-1.09 1.09L6.737 8.47a1.5 1.5 0 0 1-.954 2.303L3.5 11.23v1.54l2.282.457a1.5 1.5 0 0 1 .954 2.303l-1.291 1.936 1.09 1.09 1.935-1.292a1.5 1.5 0 0 1 2.303.954l.457 2.282h1.54l.457-2.282a1.5 1.5 0 0 1 2.303-.954l1.936 1.291 1.09-1.09-1.292-1.935a1.5 1.5 0 0 1 .954-2.303l2.282-.457v-1.54l-2.282-.457a1.5 1.5 0 0 1-.954-2.303l1.291-1.936-1.09-1.09-1.935 1.292a1.5 1.5 0 0 1-2.303-.954zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8Zm0 1.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z" class="wd-icon-fill"></path></g></svg> next to "Current Classes"</span></div>
                <span class="step-sep">→</span>
                <div class="howto-step"><span class="step-num">5</span><span>Download To Excel</span></div>
            </div>
        </div>

        <div class="step-block">
            <p class="step-heading">Step 2: Choose your .xlsx file below</p>
            <div class="file-row">
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <p class="privacy-note">
                    <svg class="privacy-icon" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                        <path
                            d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM8 3a.9.9 0 1 1 0 1.8A.9.9 0 0 1 8 3Zm1 9H7V6.5h2V12Z">
                        </path>
                    </svg>
                    <span>Runs fully in your browser — only this page and its libraries load; your schedule data never leaves your device.</span>
                </p>
            </div>
            <br>
            <button id="parseBtn" disabled>Parse File</button>
            <button id="downloadBtn" disabled>Download .ics</button>

            <div id="status">Waiting for file...</div>
        </div>

        <section id="tableSection" style="display:none;">
            <h2>Parsed Events</h2>
            <table id="preview">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Type</th>
                        <th>Days</th>
                        <th>Time</th>
                        <th>Dates</th>
                        <th>Location</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="calendarSection">
            <h2>Weekly Preview</h2>
            <div id="calendar"></div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-text">
                <h2>About this site</h2>
                <p class="footer-note">Not affiliated with the University of British Columbia or Workday.<br>This tool is provided "as is" without warranty of any kind.</p>
                <p class="footer-meta"><strong>© 2026 jamubc.</strong> <em>Licensed under the <a href="LICENSE">MIT License</a>.</em></p>
            </div>
            <div class="footer-actions">
                <div class="footer-callout">
                    <span>Don't trust this? See the source yourself</span>
                    <svg class="footer-arrow" viewBox="0 0 44 16" aria-hidden="true" focusable="false">
                        <path d="M1 8h36"></path>
                        <path d="M33 3l6 5-6 5"></path>
                    </svg>
                </div>
                <a class="footer-cta" href="https://github.com/jamubc/UBC-workday-to-calendar" target="_blank"
                    rel="noopener" aria-label="GitHub repository">
                    <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z">
                        </path>
                    </svg>
                    GitHub
                </a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        const TIMEZONE = 'America/Vancouver';
        let parsedEvents = [];
        let calendar = null;

        const fileInput = document.getElementById('fileInput');
        const parseBtn = document.getElementById('parseBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const status = document.getElementById('status');
        const tableSection = document.getElementById('tableSection');
        const calendarSection = document.getElementById('calendarSection');
        const tbody = document.querySelector('#preview tbody');

        // Initialize FullCalendar
        document.addEventListener('DOMContentLoaded', function () {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'timeGridWeek',
                slotMinTime: '07:00:00',
                slotMaxTime: '21:00:00',
                weekends: false,
                allDaySlot: false,
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                events: []
            });
            calendar.render();
        });

        fileInput.addEventListener('change', () => {
            parseBtn.disabled = !fileInput.files.length;
            downloadBtn.disabled = true;
            parsedEvents = [];
            tbody.innerHTML = '';
            tableSection.style.display = 'none';
            calendarSection.style.display = 'none';
            if (calendar) calendar.removeAllEvents();
            status.textContent = 'File selected. Click "Parse File".';
        });

        parseBtn.addEventListener('click', parseFile);
        downloadBtn.addEventListener('click', downloadICS);

        async function parseFile() {
            status.textContent = 'Parsing...\n';
            parsedEvents = [];
            tbody.innerHTML = '';
            if (calendar) calendar.removeAllEvents();

            try {
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const ws = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

                log(`Found ${rows.length} data rows`);

                let successCount = 0;
                let skipCount = 0;
                const colors = ['#3788d8', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#20c997', '#e83e8c', '#17a2b8'];
                let colorIdx = 0;
                const courseColors = {};

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];

                    const courseListing = row['Course Listing'] || '';
                    const section = row['Section'] || '';
                    const format = row['Instructional Format'] || '';
                    const meetingPatterns = row['Meeting Patterns'] || '';
                    const instructor = row['Instructor'] || '';

                    if (!courseListing || courseListing.toLowerCase().includes('course listing')) {
                        continue;
                    }

                    if (!meetingPatterns.trim()) {
                        skipCount++;
                        log(`Row ${i + 2}: Skipped (no meeting pattern) - ${courseListing.substring(0, 30)}`);
                        continue;
                    }

                    const patterns = parseUBCMeetingPatterns(meetingPatterns);

                    if (patterns.length === 0) {
                        skipCount++;
                        log(`Row ${i + 2}: Skipped (parse failed) - ${courseListing.substring(0, 30)}`);
                        continue;
                    }

                    // Assign color per course
                    const courseKey = courseListing.substring(0, 20);
                    if (!courseColors[courseKey]) {
                        courseColors[courseKey] = colors[colorIdx % colors.length];
                        colorIdx++;
                    }

                    for (const p of patterns) {
                        if (!p.startDate || !p.endDate || !p.startTime || !p.endTime || !p.days.length) {
                            continue;
                        }

                        const event = {
                            course: formatCourse(courseListing),
                            section: section,
                            format: format,
                            days: p.days,
                            startTime: p.startTime,
                            endTime: p.endTime,
                            startDate: p.startDate,
                            endDate: p.endDate,
                            location: p.location,
                            isAlternate: p.isAlternate,
                            instructor: instructor,
                            color: courseColors[courseKey]
                        };

                        parsedEvents.push(event);
                        successCount++;

                        // Add to table
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${esc(event.course)}</td>
                            <td>${esc(event.format)}</td>
                            <td>${event.days.join(', ')}</td>
                            <td>${fmtTime(event.startTime)} - ${fmtTime(event.endTime)}</td>
                            <td>${fmtDate(event.startDate)} to ${fmtDate(event.endDate)}</td>
                            <td>${esc(event.location)}</td>
                            <td>${event.isAlternate ? 'Alt weeks' : ''}</td>
                        `;
                        tbody.appendChild(tr);

                        // Add to calendar
                        addToCalendar(event);
                    }
                }

                log(`Parsed: ${successCount} events, Skipped: ${skipCount} rows`);

                if (successCount > 0) {
                    tableSection.style.display = 'block';
                    calendarSection.style.display = 'block';
                    downloadBtn.disabled = false;
                    status.className = 'success';
                    // Go to the first event's date
                    if (parsedEvents.length > 0) {
                        const firstDate = parsedEvents[0].startDate;
                        calendar.gotoDate(new Date(firstDate.year, firstDate.month - 1, firstDate.day));
                    }
                } else {
                    status.className = 'error';
                }

            } catch (err) {
                log('ERROR: ' + err.message);
                console.error(err);
                status.className = 'error';
            }
        }

        function addToCalendar(e) {
            // Generate individual occurrences to match ICS exactly
            const dayNumMap = { SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 };
            const targetDays = e.days.map(d => dayNumMap[d]);

            const startTime = `${String(e.startTime.hours).padStart(2, '0')}:${String(e.startTime.minutes).padStart(2, '0')}:00`;
            const endTime = `${String(e.endTime.hours).padStart(2, '0')}:${String(e.endTime.minutes).padStart(2, '0')}:00`;
            const title = e.format ? `${e.course} (${e.format.substring(0, 3)})` : e.course;

            const startDate = new Date(e.startDate.year, e.startDate.month - 1, e.startDate.day);
            const endDate = new Date(e.endDate.year, e.endDate.month - 1, e.endDate.day);

            // Find the first occurrence (first matching day on or after startDate)
            let firstOccurrence = new Date(startDate);
            while (!targetDays.includes(firstOccurrence.getDay()) && firstOccurrence <= endDate) {
                firstOccurrence.setDate(firstOccurrence.getDate() + 1);
            }

            // Iterate through each day from start to end
            let current = new Date(startDate);
            while (current <= endDate) {
                if (targetDays.includes(current.getDay())) {
                    // Calculate week number since first occurrence
                    const daysSinceFirst = Math.floor((current - firstOccurrence) / (24 * 60 * 60 * 1000));
                    const weekNum = Math.floor(daysSinceFirst / 7);

                    // For alternate weeks (INTERVAL=2), only show on even weeks (0, 2, 4...)
                    const shouldShow = !e.isAlternate || (weekNum % 2 === 0);

                    if (shouldShow) {
                        const dateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                        calendar.addEvent({
                            title: title,
                            start: `${dateStr}T${startTime}`,
                            end: `${dateStr}T${endTime}`,
                            color: e.color,
                            extendedProps: { location: e.location }
                        });
                    }
                }
                current.setDate(current.getDate() + 1);
            }
        }

        function log(msg) {
            status.textContent += msg + '\n';
        }

        function parseUBCMeetingPatterns(str) {
            const results = [];
            const lines = str.split(/\n/).map(l => l.trim()).filter(l => l.length > 0);
            for (const line of lines) {
                const parsed = parseSinglePattern(line);
                if (parsed) results.push(parsed);
            }
            return results;
        }

        function parseSinglePattern(line) {
            const parts = line.split('|').map(p => p.trim());
            if (parts.length < 3) return null;

            const dateRange = parseDateRange(parts[0]);
            if (!dateRange.start || !dateRange.end) return null;

            const daysPart = parts[1];
            const isAlternate = daysPart.toLowerCase().includes('alternate');
            const days = parseDays(daysPart.replace(/\(alternate\s*weeks?\)/gi, ''));
            if (days.length === 0) return null;

            const times = parseTimeRange(parts[2]);
            if (!times.start || !times.end) return null;

            let location = '';
            if (parts.length >= 5) {
                const building = parts[4] || '';
                const roomPart = parts.find(p => p.toLowerCase().startsWith('room'));
                const room = roomPart ? roomPart.replace(/room:\s*/i, 'Rm ') : '';
                location = (building + ' ' + room).trim();
            }

            return {
                startDate: dateRange.start, endDate: dateRange.end,
                days: days, startTime: times.start, endTime: times.end,
                location: location, isAlternate: isAlternate
            };
        }

        function parseDateRange(str) {
            const match = str.match(/(\d{4}-\d{2}-\d{2})\s*[-–]\s*(\d{4}-\d{2}-\d{2})/);
            if (!match) return { start: null, end: null };
            return { start: parseISODate(match[1]), end: parseISODate(match[2]) };
        }

        function parseISODate(str) {
            const m = str.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (!m) return null;
            return { year: parseInt(m[1]), month: parseInt(m[2]), day: parseInt(m[3]) };
        }

        function parseDays(str) {
            const dayMap = { 'mo': 'MO', 'mon': 'MO', 'tu': 'TU', 'tue': 'TU', 'we': 'WE', 'wed': 'WE', 'th': 'TH', 'thu': 'TH', 'fr': 'FR', 'fri': 'FR', 'sa': 'SA', 'sat': 'SA', 'su': 'SU', 'sun': 'SU' };
            const days = [];
            const tokens = str.toLowerCase().split(/[\s\/,]+/);
            for (const token of tokens) {
                for (const [key, val] of Object.entries(dayMap)) {
                    if (token === key || token.startsWith(key)) {
                        if (!days.includes(val)) days.push(val);
                        break;
                    }
                }
            }
            return days;
        }

        function parseTimeRange(str) {
            const normalized = str.replace(/a\.m\./gi, 'AM').replace(/p\.m\./gi, 'PM');
            const match = normalized.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?\s*[-–]\s*(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
            if (!match) return { start: null, end: null };
            return { start: normalizeTime(match[1], match[2], match[3]), end: normalizeTime(match[4], match[5], match[6]) };
        }

        function normalizeTime(h, m, period) {
            let hours = parseInt(h, 10);
            const minutes = parseInt(m, 10);
            if (period) {
                period = period.toUpperCase();
                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;
            }
            return { hours, minutes };
        }

        function formatCourse(name) { return name.replace(/\s*[-–]\s*/, ' ').substring(0, 50); }
        function fmtTime(t) {
            if (!t) return '?';
            let h = t.hours; const m = String(t.minutes).padStart(2, '0');
            const p = h >= 12 ? 'PM' : 'AM';
            if (h > 12) h -= 12; if (h === 0) h = 12;
            return `${h}:${m} ${p}`;
        }
        function fmtDate(d) { return d ? `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}` : '?'; }
        function esc(s) { const div = document.createElement('div'); div.textContent = s || ''; return div.innerHTML; }

        function downloadICS() {
            if (!parsedEvents.length) return;
            let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//UBC Workday to Calendar//EN\r\nCALSCALE:GREGORIAN\r\n';
            ics += 'BEGIN:VTIMEZONE\r\nTZID:America/Vancouver\r\n';
            ics += 'BEGIN:DAYLIGHT\r\nTZOFFSETFROM:-0800\r\nTZOFFSETTO:-0700\r\nTZNAME:PDT\r\nDTSTART:19700308T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU\r\nEND:DAYLIGHT\r\n';
            ics += 'BEGIN:STANDARD\r\nTZOFFSETFROM:-0700\r\nTZOFFSETTO:-0800\r\nTZNAME:PST\r\nDTSTART:19701101T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU\r\nEND:STANDARD\r\n';
            ics += 'END:VTIMEZONE\r\n';

            for (const e of parsedEvents) {
                const firstDate = findFirstOccurrence(e.startDate, e.days);
                const dtstart = fmtICSDateTime(firstDate, e.startTime);
                const dtend = fmtICSDateTime(firstDate, e.endTime);
                const until = fmtICSDate(e.endDate) + 'T235959Z';
                const uid = Math.random().toString(36).substring(2) + '@ubc-calendar';
                let rrule = `FREQ=WEEKLY;BYDAY=${e.days.join(',')};UNTIL=${until}`;
                if (e.isAlternate) rrule = `FREQ=WEEKLY;INTERVAL=2;BYDAY=${e.days.join(',')};UNTIL=${until}`;
                const summary = e.format ? `${e.course} (${e.format})` : e.course;

                ics += 'BEGIN:VEVENT\r\n';
                ics += `UID:${uid}\r\n`;
                ics += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\r\n`;
                ics += `DTSTART;TZID=${TIMEZONE}:${dtstart}\r\n`;
                ics += `DTEND;TZID=${TIMEZONE}:${dtend}\r\n`;
                ics += `RRULE:${rrule}\r\n`;
                ics += `SUMMARY:${escICS(summary)}\r\n`;
                if (e.location) ics += `LOCATION:${escICS(e.location)}\r\n`;
                if (e.instructor) ics += `DESCRIPTION:Instructor: ${escICS(e.instructor)}\r\n`;
                ics += 'END:VEVENT\r\n';
            }
            ics += 'END:VCALENDAR\r\n';

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'ubc_schedule.ics'; a.click();
            URL.revokeObjectURL(url);
        }

        function findFirstOccurrence(startDate, days) {
            const dayNum = { SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 };
            const targetDays = days.map(d => dayNum[d]);
            const date = new Date(startDate.year, startDate.month - 1, startDate.day);
            for (let i = 0; i < 7; i++) {
                if (targetDays.includes(date.getDay())) {
                    return { year: date.getFullYear(), month: date.getMonth() + 1, day: date.getDate() };
                }
                date.setDate(date.getDate() + 1);
            }
            return startDate;
        }

        function fmtICSDateTime(date, time) {
            return `${date.year}${String(date.month).padStart(2, '0')}${String(date.day).padStart(2, '0')}T${String(time.hours).padStart(2, '0')}${String(time.minutes).padStart(2, '0')}00`;
        }
        function fmtICSDate(date) { return `${date.year}${String(date.month).padStart(2, '0')}${String(date.day).padStart(2, '0')}`; }
        function escICS(s) { return (s || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n'); }
    </script>
</body>

</html>
